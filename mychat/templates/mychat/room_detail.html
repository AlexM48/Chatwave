{% extends "mychat/base.html" %}
{% load static %}

{% block content %}

<link rel="stylesheet" href="{% static 'mychat/style.css' %}?v=3">
<script defer src="{% static 'mychat/js/room.js' %}?v=3"></script>

<div class="chat-wrapper">
    <!-- === –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å === -->
    <div class="chat-sidebar">
        <a class="back-btn" href="{% url 'mychat:room_list' %}">–Ω–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –∫–æ–º–Ω–∞—Ç</a>

        <div class="room-title">–ö–æ–º–Ω–∞—Ç–∞: {{ room.name }}</div>

        <div class="sidebar-block">
            <div class="sidebar-label">–£—á–∞—Å—Ç–Ω–∏–∫–∏:</div>
            <div class="sidebar-users">
                {% if users %}
                    {% for u in users %}
                        <div class="user-item">{{ u.username }}</div>
                    {% endfor %}
                {% else %}
                    <div class="user-item empty">–Ω–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
                {% endif %}
            </div>
        </div>

        <div class="sidebar-block">
            <div class="sidebar-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π:</div>
            <div id="message-count">{{ messages_count }}</div>
        </div>
    </div>

    <!-- === –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å ‚Äî —á–∞—Ç === -->
    <div class="chat-container">
        <div id="messages-area" class="messages-area">
            {% for msg in messages %}
                <div id="message-{{ msg.id }}" 
                     class="message
                        {% if msg.user == request.user %} self-msg
                        {% elif msg.user.is_superuser %} admin-msg
                        {% else %} user-msg {% endif %}"
                     data-username="{{ msg.user.username }}"
                     data-message-id="{{ msg.id }}"
                >
                    <div class="msg-header">
                        <span class="msg-username">{{ msg.user.username }}</span>
                    </div>

                    {% if msg.content %}
                        <div class="msg-text">{{ msg.content }}</div>
                    {% endif %}

                    {% if msg.image %}
                        <div class="msg-image">
                            <img src="{{ msg.image.url }}" class="chat-photo" alt="image">
                        </div>
                    {% endif %}

                    {% if msg.video %}
                        <div class="msg-video">
                            <video class="chat-video" controls preload="metadata">
                                <source src="{{ msg.video.url }}" type="video/mp4">
                            </video>
                        </div>
                    {% endif %}

                    {% if can_delete_messages %}
                        <button class="msg-delete-btn" data-id="{{ msg.id }}">√ó</button>
                    {% endif %}
                </div>
            {% endfor %}
        </div>

        <!-- === –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è === -->
        <form id="chat-form" class="chat-input-block" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <input id="chat-input" name="content" type="text" class="chat-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
            
            <label class="chat-file-label">
                <input id="chat-media" name="media" type="file" class="chat-file">
                üìé
            </label>

            <button type="submit" class="chat-send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </form>
    </div>
</div>

{% if error_message %}
    <div class="error-message" style="color: red; margin-bottom: 1em;">
        {{ error_message }}
    </div>
{% endif %}

<!-- === –°–∫—Ä—ã—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã === -->
<div id="can_delete_messages" hidden>{{ can_delete_messages|lower }}</div>
<div id="current_username" hidden>{{ request.user.username }}</div>

{% endblock %}
